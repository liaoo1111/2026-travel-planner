<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 東北藏王冰雪之旅</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snow-white': '#F0FFFF',        // 雪白色
                        'ice-blue': '#B3E5FC',          // 冰川藍
                        'light-snow-blue': '#E5F3F7',   // 整體背景
                        'deep-sea-blue': '#01579B',     // 深海藍
                        'nav-base': '#CFD8DC',          // 導航圖示底色
                        'nav-arrow': '#01579B',         // 導航箭頭
                        'accent-yellow': '#FFD54F',     // 重點黃
                        'note-yellow': '#FEFCE8',       // 便利貼黃
                        'note-border': '#FEF08A',       // 便利貼邊框
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(179, 229, 252, 0.4)',
                        'float': '0 8px 32px 0 rgba(1, 87, 155, 0.15)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap');
        
        body {
            background-color: #E5F3F7;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans TC', sans-serif;
            color: #334155;
        }
        
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
            position: relative;
            padding-bottom: 20px;
        }
        /* --- Header Design --- */
        .header-bg {
            background-color: #ffffff;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            z-index: 10;
            height: 250px; /* 已調整為 250px */
        }
        
        .header-image-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .header-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        /* 漸層遮罩 */
        .header-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(1, 87, 155, 0.3) 0%, transparent 60%);
        }
        /* 雪花特效 */
        .snow-layer {
            position: absolute;
            inset: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="white" opacity="0.8"/><circle cx="20" cy="80" r="0.8" fill="white" opacity="0.6"/><circle cx="80" cy="20" r="1.2" fill="white" opacity="0.9"/></svg>');
            background-size: 150px 150px;
            opacity: 0.8;
            animation: snowfall 15s linear infinite;
            pointer-events: none;
        }
        @keyframes snowfall {
            from { background-position: 0 0; }
            to { background-position: 150px 150px; }
        }
        /* Tab Bar (Floating) */
        .side-tab-bar {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 30;
            display: flex;
            gap: 10px;
        }
        
        .tab-button {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            background-color: rgba(255, 255, 255, 0.9);
            color: #90A4AE;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid white;
        }
        
        .tab-button.active {
            background-color: #01579B;
            color: white;
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 15px rgba(1, 87, 155, 0.3);
        }
        /* Main Content */
        .app-main {
            padding-top: 20px;
            position: relative;
            z-index: 5;
            min-height: calc(100vh - 250px);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(179, 229, 252, 0.25);
            border: 1px solid rgba(179, 229, 252, 0.4);
        }
        
        /* --- Timeline Styles --- */
        /* 垂直連接線 */
        .timeline-line {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 28px;
            bottom: -20px;
            width: 2px;
            background-color: #E0F7FA;
            z-index: 0;
        }
        .last-item .timeline-line { display: none; }
        
        /* 必搭紅框動畫 */
        .urgent-border {
            border: 1px solid #FF8A80 !important;
            box-shadow: 0 0 0 1px #FF8A80, 0 4px 10px rgba(255, 138, 128, 0.2);
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(255, 138, 128, 0.4); }
            70% { box-shadow: 0 0 0 4px rgba(255, 138, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 138, 128, 0); }
        }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        /* Sticky Date Selector */
        .date-selector-sticky {
            position: sticky;
            top: 0;
            background: linear-gradient(to bottom, #ffffff 80%, rgba(255,255,255,0));
            z-index: 20;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div id="app" class="app-container">
    
    <!-- 1. HEADER -->
    <div class="header-bg">
        <div class="header-image-container group">
            <img :src="coverImage" alt="Header" @error="handleImageError">
            <div class="header-overlay"></div>
            <div class="snow-layer"></div>
            
            <!-- 右上角按鈕群組 -->
            <div class="absolute top-5 right-5 z-20 flex gap-2">
                <!-- 重置按鈕 -->
                <button @click="resetCover" class="w-8 h-8 bg-white/20 hover:bg-white/40 backdrop-blur-md rounded-full flex items-center justify-center text-white transition border border-white/20" title="強制讀取 lia.jpg">
                    <i class="fa-solid fa-rotate-right text-xs"></i>
                </button>
                <!-- 上傳按鈕 -->
                <button @click="triggerFileInput" class="w-8 h-8 bg-black/20 hover:bg-black/40 backdrop-blur-md rounded-full flex items-center justify-center text-white transition border border-white/20">
                    <i class="fa-solid fa-camera text-xs"></i>
                </button>
            </div>
            
            <input type="file" ref="fileInput" @change="handleImageUpload" accept="image/*" class="hidden">
            <!-- 日期 -->
            <div class="absolute bottom-[70px] right-5 z-20">
                <span class="text-xs font-bold text-white tracking-widest font-mono bg-deep-sea-blue/40 px-3 py-1 rounded-full backdrop-blur-md border border-white/20 shadow-sm">
                    2026.01.14 - 01.19
                </span>
            </div>
        </div>
        <!-- Tab Bar -->
        <div class="side-tab-bar">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                :class="['tab-button', {'active': currentTab === tab.id}]">
                <i :class="tab.icon"></i>
            </button>
        </div>
    </div>
    <!-- 2. MAIN CONTENT -->
    <main class="app-main px-5 pb-24">
        <transition name="fade" mode="out-in">
            
            <!-- TAB: ITINERARY -->
            <div v-if="currentTab === 'itinerary'" key="itinerary">
                
                <!-- 天氣卡片 -->
                <div class="mb-4 bg-gradient-to-r from-sky-50 to-white border border-ice-blue rounded-2xl p-4 flex justify-between items-center shadow-sm">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-deep-sea-blue shadow-sm">
                            <i :class="weatherInfo.icon" class="text-xl"></i>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-deep-sea-blue leading-none">{{ weatherInfo.temp }}</div>
                            <div class="text-xs text-slate-400 mt-0.5">{{ weatherInfo.desc }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-lg">體感 {{ weatherInfo.feel }}</div>
                    </div>
                </div>
                <!-- 日期選單 (Sticky) -->
                <div class="date-selector-sticky -mx-5 px-5 pt-1">
                    <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-2">
                        <div v-for="(day, index) in tripDays" :key="index" 
                             @click="selectedDayIndex = index"
                             :class="[
                                'flex-shrink-0 w-[52px] h-[64px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all border-2',
                                selectedDayIndex === index 
                                    ? 'bg-deep-sea-blue text-white border-deep-sea-blue shadow-lg scale-105' 
                                    : 'bg-white text-slate-400 border-white shadow-sm hover:bg-slate-50'
                             ]">
                            <span class="text-[10px] font-bold uppercase tracking-wider">{{ day.week }}</span>
                            <span class="text-lg font-bold font-mono leading-tight">{{ day.dayNum }}</span>
                        </div>
                    </div>
                </div>
                <!-- 行程列表 (Timeline Layout) -->
                <div class="space-y-0 relative pb-4">
                    <div v-if="currentDayItinerary.length === 0" class="text-center py-10 text-slate-300">
                        <i class="fa-solid fa-map-location-dot text-4xl mb-3 opacity-50"></i>
                        <p class="text-xs">點擊 + 新增行程</p>
                    </div>
                    <div v-for="(item, index) in currentDayItinerary" :key="item.id" 
                         class="group flex items-stretch mb-2"
                         :class="{ 'last-item': index === currentDayItinerary.length - 1 }">
                        
                        <!-- 1. 左側時間 -->
                        <div class="w-14 flex-shrink-0 flex flex-col items-end pt-1 pr-3">
                            <span class="text-sm font-black text-slate-700 font-mono leading-none">{{ item.startTime }}</span>
                            <span v-if="item.endTime" class="text-[10px] text-slate-400 font-mono mt-1">{{ item.endTime }}</span>
                        </div>
                        <!-- 2. 中間軸線與地標ICON -->
                        <div class="relative w-4 flex flex-col items-center flex-shrink-0">
                            <!-- 連接線 -->
                            <div class="timeline-line"></div>
                            <!-- 地標 ICON (取代圓點) -->
                            <div class="z-10 bg-white p-0.5 rounded-full mt-0.5">
                                <i class="fa-solid fa-location-dot text-lg drop-shadow-sm" 
                                   :class="getCategoryTheme(item.category).text"></i>
                            </div>
                        </div>
                        <!-- 3. 右側卡片 -->
                        <div class="flex-1 pl-3 pb-5 min-w-0" @click="openEditModal(item, index)">
                            <div class="bg-white rounded-2xl p-3 card-shadow relative overflow-hidden active:scale-[0.98] transition-all"
                                 :class="{'urgent-border': isImportant(item.note)}">
                                
                                <!-- 航班特殊樣式 -->
                                <div v-if="item.category === 'flight'">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded font-bold uppercase tracking-wide">FLIGHT</span>
                                        <div class="text-xs text-slate-400 font-mono flex items-center"><i class="fa-regular fa-clock mr-1"></i>{{ item.endTime }} 抵達</div>
                                    </div>
                                    <div class="flex justify-between items-center px-1 py-1">
                                        <div class="text-lg font-black text-deep-sea-blue">{{ item.name.includes('返') ? 'NRT' : 'TPE' }}</div>
                                        <div class="flex flex-col items-center px-2">
                                            <i class="fa-solid fa-plane text-ice-blue transform rotate-45 text-xl"></i>
                                            <span class="text-[9px] text-slate-400 mt-1">{{ item.name.split(' ')[0] }}</span>
                                        </div>
                                        <div class="text-lg font-black text-deep-sea-blue">{{ item.name.includes('返') ? 'TPE' : 'NRT' }}</div>
                                    </div>
                                </div>
                                
                                <!-- 一般樣式 -->
                                <div v-else>
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="flex-1 pr-2 min-w-0">
                                            <!-- 標題 + 有顏色的 ICON -->
                                            <h3 class="text-sm font-bold text-deep-sea-blue leading-snug flex items-center">
                                                <div class="w-6 h-6 rounded-full flex items-center justify-center mr-1.5 flex-shrink-0"
                                                     :class="getCategoryTheme(item.category).bgLight">
                                                    <i :class="[getCategoryTheme(item.category).icon, getCategoryTheme(item.category).text]" class="text-xs"></i>
                                                </div>
                                                {{ item.name }}
                                            </h3>
                                            
                                            <!-- 分類與交通標籤 -->
                                            <div class="flex flex-wrap items-center gap-1.5 mt-1.5">
                                                <span class="text-[9px] px-1.5 py-0.5 rounded bg-slate-50 text-slate-500 border border-slate-100 whitespace-nowrap">
                                                    {{ getCategoryName(item.category) }}
                                                </span>
                                                <!-- 必搭 -->
                                                <span v-if="isImportant(item.note)" class="inline-flex items-center text-[9px] bg-red-50 text-red-500 px-1.5 py-0.5 rounded font-bold border border-red-100 whitespace-nowrap">
                                                    必搭
                                                </span>
                                            </div>
                                        </div>
                                        <!-- 導航按鈕 -->
                                        <button @click.stop="openMap(item.name)" class="w-8 h-8 rounded-full bg-nav-base text-nav-arrow flex items-center justify-center hover:bg-deep-sea-blue hover:text-white transition-colors flex-shrink-0 shadow-sm ml-1">
                                            <i class="fa-solid fa-location-arrow text-xs"></i>
                                        </button>
                                    </div>
                                    <!-- 資訊欄位區 -->
                                    <div v-if="item.openTime || (item.ticketCost && item.category === 'sightseeing')" class="mt-2 pt-2 border-t border-slate-50 grid grid-cols-2 gap-2">
                                        <div v-if="item.openTime" class="flex items-center text-[10px] text-slate-500">
                                            <i class="fa-regular fa-clock text-slate-400 w-4"></i>
                                            <span>{{ item.openTime }}</span>
                                        </div>
                                        <div v-if="item.ticketCost && item.category === 'sightseeing'" class="flex items-center text-[10px] text-slate-500">
                                            <i class="fa-solid fa-ticket text-yellow-500 w-4"></i>
                                            <span>{{ item.ticketCost }}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- 優化後的備註區塊 (黃色鉛筆風格) -->
                                    <div v-if="item.note" class="mt-2 text-xs bg-note-yellow p-2 rounded-lg text-slate-700 leading-relaxed border border-note-border shadow-sm">
                                        <div>
                                            <!-- 黃色鉛筆 ICON + 備註 -->
                                            <div class="flex items-center mb-0.5">
                                                <i class="fa-solid fa-pencil text-yellow-500 mr-1.5 text-[10px]"></i>
                                                <span class="font-bold text-slate-600 text-[10px]">備註</span>
                                            </div>
                                            <!-- 內容直接顯示，不需折疊 -->
                                            <div class="whitespace-pre-wrap">{{ item.note }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 交通方式 -->
                            <div v-if="index < currentDayItinerary.length - 1" class="mt-2 ml-1">
                                <div class="inline-flex items-center gap-1.5 text-[9px] text-slate-400 bg-white/50 px-2 py-0.5 rounded-full border border-slate-100">
                                    <i :class="getTransportIcon(item.transportType)" class="text-slate-300"></i>
                                    <i class="fa-solid fa-arrow-down text-[8px] opacity-50"></i>
                                    <span class="font-mono">{{ item.transportTime || '15' }}m</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- FAB Button -->
                <button @click="openAddModal" class="fixed bottom-6 right-6 w-14 h-14 bg-accent-yellow text-deep-sea-blue rounded-full shadow-[0_4px_15px_rgba(255,213,79,0.5)] flex items-center justify-center text-xl hover:scale-110 transition-transform z-40">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
            <!-- TAB: INFO -->
            <div v-else-if="currentTab === 'info'" key="info" class="space-y-5 pt-2">
                <!-- 旅遊必備 -->
                <div class="grid grid-cols-2 gap-3">
                    <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" class="bg-gradient-to-br from-blue-600 to-blue-500 text-white p-3 rounded-2xl shadow-lg flex items-center space-x-3 active:scale-95 transition-transform">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><i class="fa-solid fa-passport"></i></div>
                        <div><div class="text-[10px] font-bold opacity-80">入境</div><div class="text-sm font-bold">VJW 網站</div></div>
                    </a>
                    <div class="bg-gradient-to-br from-emerald-500 to-emerald-400 text-white p-3 rounded-2xl shadow-lg flex items-center space-x-3">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><i class="fa-solid fa-train"></i></div>
                        <div><div class="text-[10px] font-bold opacity-80">交通</div><div class="text-sm font-bold">Suica</div></div>
                    </div>
                </div>
                <!-- 匯率 -->
                <div class="bg-white p-5 rounded-3xl card-shadow border border-ice-blue/30">
                    <h3 class="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider flex items-center"><i class="fa-solid fa-calculator mr-2 text-accent-yellow"></i>匯率換算</h3>
                    <div class="flex items-center justify-between space-x-3">
                        <div class="flex-1 bg-slate-50 rounded-xl px-3 py-2 border border-slate-100">
                            <label class="text-[10px] text-slate-400 block mb-0.5">JPY</label>
                            <input type="number" v-model="exchangeInput" class="w-full text-lg font-bold bg-transparent outline-none text-deep-sea-blue font-mono" placeholder="0">
                        </div>
                        <i class="fa-solid fa-right-left text-ice-blue"></i>
                        <div class="flex-1 bg-blue-50 rounded-xl px-3 py-2 border border-blue-100">
                            <label class="text-[10px] text-blue-400 block mb-0.5">TWD</label>
                            <div class="text-lg font-bold text-blue-600 font-mono">{{ exchangeResult }}</div>
                        </div>
                    </div>
                </div>
                <!-- 住宿列表 -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-slate-400 px-1">住宿資訊</h3>
                    <div v-for="hotel in hotels" :key="hotel.name" @click="openMap(hotel.name)" class="bg-white p-4 rounded-2xl card-shadow flex items-center space-x-3 cursor-pointer hover:bg-slate-50">
                        <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500 flex-shrink-0"><i class="fa-solid fa-hotel"></i></div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-sm text-slate-700 truncate">{{ hotel.name }}</div>
                            <div class="text-xs text-slate-400">{{ hotel.note }}</div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-xs text-slate-300"></i>
                    </div>
                </div>
            </div>
            <!-- TAB: LISTS -->
            <div v-else-if="currentTab === 'lists'" key="lists" class="space-y-4 pb-20 pt-2">
                <!-- 子選單 -->
                <div class="bg-white p-1.5 rounded-2xl shadow-sm flex border border-slate-100">
                    <button v-for="type in listTypes" :key="type.id" @click="currentListType = type.id" 
                        class="flex-1 py-2 rounded-xl text-xs font-bold transition-all text-center" 
                        :class="currentListType === type.id ? 'bg-deep-sea-blue text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'">
                        {{ type.name }}
                    </button>
                </div>
                <!-- 1. 購物 (Icon List View) -->
                <div v-if="currentListType === 'shopping'">
                    <!-- 推薦區塊 -->
                    <div class="mb-5">
                        <h3 class="text-xs font-bold text-slate-400 mb-3 px-1 flex items-center"><i class="fa-solid fa-thumbs-up text-accent-yellow mr-1.5"></i>在地必買</h3>
                        <div class="flex overflow-x-auto space-x-3 pb-2 hide-scrollbar px-1">
                            <div v-for="rec in recommendations" :key="rec.name" @click="addRecItem(rec)" class="flex-shrink-0 w-24 bg-white p-2 rounded-2xl border border-slate-100 shadow-sm cursor-pointer hover:border-ice-blue transition-colors">
                                <div class="h-10 bg-slate-50 rounded-lg flex items-center justify-center text-lg mb-1">{{ rec.icon }}</div>
                                <div class="text-[10px] font-bold text-slate-700 truncate">{{ rec.name }}</div>
                                <div class="text-[9px] text-slate-400 truncate">{{ rec.city }}</div>
                            </div>
                        </div>
                    </div>
                    <!-- 購物清單 -->
                    <div class="space-y-3">
                        <div v-for="(item, idx) in lists.shopping" :key="idx" class="bg-white p-3 rounded-2xl card-shadow flex items-center group relative overflow-hidden">
                            <!-- Icon (取代圖片) -->
                            <div class="w-12 h-12 rounded-xl flex-shrink-0 flex items-center justify-center border border-slate-100 mr-3"
                                 :class="item.checked ? 'bg-slate-100 text-slate-300' : 'bg-pink-50 text-pink-500'">
                                <i :class="getShoppingIcon(item.name)" class="text-xl"></i>
                            </div>
                            <!-- 文字內容 -->
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-slate-700 text-sm truncate mb-0.5">{{ item.name }}</h4>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="item.checked" class="w-3.5 h-3.5 rounded text-pink-500 border-slate-300 focus:ring-0">
                                    <span class="ml-1.5 text-xs text-slate-400" :class="{'line-through': item.checked}">{{ item.checked ? '已購入' : '待買' }}</span>
                                </label>
                            </div>
                            <!-- 刪除按鈕 -->
                            <button @click="deleteListItem('shopping', idx)" class="w-8 h-8 rounded-full bg-slate-50 text-slate-300 flex items-center justify-center hover:bg-red-50 hover:text-red-400 transition-colors ml-2">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button @click="openListModal" class="fixed bottom-6 right-6 w-14 h-14 bg-accent-yellow text-deep-sea-blue rounded-full shadow-[0_4px_15px_rgba(255,213,79,0.5)] flex items-center justify-center text-xl z-40 hover:scale-110 transition-transform"><i class="fa-solid fa-cart-plus"></i></button>
                </div>
                <!-- 2. 待辦 -->
                <div v-else-if="currentListType === 'todo'" class="space-y-2">
                    <div v-for="(item, idx) in lists.todo" :key="idx" class="bg-white p-4 rounded-2xl card-shadow flex items-center group">
                        <input type="checkbox" v-model="item.checked" class="w-5 h-5 rounded border-slate-300 text-deep-sea-blue focus:ring-0">
                        <span class="ml-3 text-sm font-medium flex-1 text-slate-700" :class="{'line-through text-slate-300': item.checked}">{{ item.name }}</span>
                        <button @click="deleteListItem('todo', idx)" class="text-slate-200 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <button @click="openListModal" class="fixed bottom-6 right-6 w-14 h-14 bg-deep-sea-blue text-white rounded-full shadow-lg flex items-center justify-center text-xl z-40"><i class="fa-solid fa-plus"></i></button>
                </div>
                <!-- 3. 行李 -->
                <div v-else-if="currentListType === 'packing'" class="space-y-2">
                    <div class="bg-blue-50 p-3 rounded-2xl mb-3 text-xs text-blue-600 flex items-start border border-blue-100">
                        <i class="fa-solid fa-snowflake mr-2 mt-0.5"></i>
                        <div>藏王極冷 (-5°C)，請務必檢查保暖裝備！</div>
                    </div>
                    <div v-for="(item, idx) in lists.packing" :key="idx" class="bg-white p-3 rounded-2xl border border-slate-100 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" v-model="item.checked" class="w-4 h-4 rounded border-slate-300 text-indigo-500 focus:ring-0">
                            <span class="text-sm text-slate-700" :class="{'line-through text-slate-300': item.checked}">{{ item.name }}</span>
                        </div>
                        <button @click="deleteListItem('packing', idx)" class="text-slate-200 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="flex mt-3 space-x-2">
                        <input v-model="newPackingItem" placeholder="新增項目..." class="flex-1 bg-slate-50 rounded-xl px-3 py-2 text-sm outline-none border border-transparent focus:border-ice-blue">
                        <button @click="quickAddPacking" class="bg-deep-sea-blue text-white w-10 h-10 rounded-xl"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
            </div>
            <!-- TAB: EXPENSES -->
            <div v-else-if="currentTab === 'expenses'" key="expenses" class="space-y-4 pt-2 pb-20">
                <div class="bg-gradient-to-br from-deep-sea-blue to-cyan-800 text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
                    <div class="absolute -right-8 -top-8 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                    <p class="text-xs text-cyan-200 uppercase tracking-widest font-medium mb-1">Total Expenses (NT$)</p>
                    <h2 class="text-4xl font-bold font-mono tracking-tight mb-2">NT$ {{ totalExpensesTWD.toLocaleString() }}</h2>
                    
                    <!-- 分類統計：現金 vs 信用卡 -->
                    <div class="flex justify-between mt-4 pt-4 border-t border-white/20">
                        <div>
                            <div class="text-[10px] text-cyan-200 opacity-80 mb-0.5"><i class="fa-solid fa-money-bill-wave mr-1"></i>現金 (NT$)</div>
                            <div class="text-lg font-bold font-mono">{{ expenseStats.cash.toLocaleString() }}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-cyan-200 opacity-80 mb-0.5">信用卡 (NT$)<i class="fa-regular fa-credit-card ml-1"></i></div>
                            <div class="text-lg font-bold font-mono">{{ expenseStats.card.toLocaleString() }}</div>
                        </div>
                    </div>
                    <!-- 日幣總計 (放到下方角落) -->
                    <div class="absolute top-4 right-4 bg-white/10 rounded-lg p-2 backdrop-blur-sm border border-white/5">
                        <span class="text-[10px] text-cyan-100 block text-right">約 JPY</span>
                        <span class="text-base font-bold">¥{{ Math.round(totalExpensesJPY).toLocaleString() }}</span>
                    </div>
                </div>
                
                <div class="bg-white rounded-3xl card-shadow px-4 py-2">
                    <div v-if="expenses.length === 0" class="py-10 text-center text-slate-300 text-sm">
                        尚無記帳資料
                    </div>
                    <div v-for="(exp, idx) in sortedExpenses" :key="idx" class="py-4 border-b border-slate-50 last:border-0 flex justify-between items-center group relative">
                        <button @click="deleteExpense(idx)" class="absolute right-0 bg-red-50 text-red-400 px-2 py-1 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-trash-can"></i></button>
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm shadow-sm" :class="getExpenseColor(exp.category)">
                                <i :class="getExpenseIcon(exp.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-sm text-slate-700">{{ exp.name }}</div>
                                <div class="text-[10px] text-slate-400 flex items-center gap-1">
                                    {{ exp.date.slice(5) }} · 
                                    <span :class="exp.payment === '信用卡' ? 'text-blue-400' : 'text-orange-400'">{{ exp.payment }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-slate-700 font-mono">
                                {{ exp.currency === 'TWD' ? 'NT$' : '¥' }}{{ parseInt(exp.amount).toLocaleString() }}
                            </div>
                            <!-- 如果是日幣，顯示約合台幣 -->
                            <div v-if="exp.currency === 'JPY'" class="text-[9px] text-slate-400 font-mono">
                                ≈ NT${{ Math.round(parseInt(exp.amount) * 0.22).toLocaleString() }}
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openExpenseModal" class="fixed bottom-6 right-6 w-14 h-14 bg-emerald-400 text-white rounded-full shadow-[0_4px_15px_rgba(52,211,153,0.4)] flex items-center justify-center text-xl z-40 hover:scale-110 transition-transform"><i class="fa-solid fa-pen"></i></button>
            </div>
        </transition>
    </main>
    <!-- MODALS -->
    <!-- 1. Itinerary Modal (新增/編輯行程) -->
    <div v-if="showItineraryModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-deep-sea-blue/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-deep-sea-blue text-center">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-3">
                <div class="flex space-x-2">
                    <select v-model="formItinerary.category" class="bg-slate-50 rounded-xl p-3 text-sm flex-1 outline-none border border-transparent focus:border-ice-blue">
                        <option value="sightseeing">景點</option><option value="food">美食</option><option value="shopping">購物</option><option value="hotel">住宿</option><option value="flight">航班</option><option value="transport">交通</option>
                    </select>
                    <input v-model="formItinerary.startTime" type="time" class="bg-slate-50 rounded-xl p-3 text-sm w-1/3 outline-none border border-transparent focus:border-ice-blue">
                </div>
                <input v-model="formItinerary.name" placeholder="名稱" class="w-full bg-slate-50 rounded-xl p-3 text-sm font-bold outline-none border border-transparent focus:border-ice-blue">
                
                <!-- 新增：營業時間 -->
                <div v-if="['sightseeing', 'food', 'shopping', 'hotel'].includes(formItinerary.category)" class="flex items-center space-x-2">
                    <i class="fa-regular fa-clock text-slate-300"></i>
                    <input v-model="formItinerary.openTime" placeholder="營業時間 (例: 09:00-17:00)" class="flex-1 bg-slate-50 rounded-xl p-2 text-sm outline-none">
                </div>
                <div class="bg-blue-50/50 p-2 rounded-xl flex items-center space-x-2 border border-blue-50">
                    <span class="text-[10px] text-blue-400 font-bold whitespace-nowrap px-1">下一站</span>
                    <select v-model="formItinerary.transportType" class="bg-white rounded-lg p-1.5 text-xs outline-none text-slate-600">
                        <option value="walk">步行</option><option value="car">汽車</option><option value="public">大眾運輸</option>
                    </select>
                    <input v-model="formItinerary.transportTime" type="number" placeholder="分" class="flex-1 bg-white rounded-lg p-1.5 text-xs text-center outline-none">
                    <span class="text-xs text-slate-400">min</span>
                </div>
                <textarea v-model="formItinerary.note" placeholder="特色 & 備註" rows="3" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none border border-transparent focus:border-ice-blue"></textarea>
                
                <div v-if="formItinerary.category === 'sightseeing'" class="flex items-center space-x-2">
                    <i class="fa-solid fa-ticket text-slate-300"></i>
                    <input v-model="formItinerary.ticketCost" placeholder="門票費用" class="flex-1 bg-slate-50 rounded-xl p-2 text-sm outline-none">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <!-- 刪除按鈕 -->
                <button v-if="isEditing" @click="confirmDeleteItinerary" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold text-sm border border-red-100">刪除</button>
                <button @click="showItineraryModal = false" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold text-sm">取消</button>
                <button @click="saveItinerary" class="flex-[2] bg-deep-sea-blue text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-900/20">儲存</button>
            </div>
        </div>
    </div>
    <!-- 2. List Modal (購物/待辦) -->
    <div v-if="showListModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-deep-sea-blue/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-center text-slate-800">新增{{ currentListTypeName }}</h3>
            <div class="space-y-4">
                <input v-model="formList.name" type="text" placeholder="項目名稱" class="w-full bg-slate-50 rounded-xl p-4 text-sm outline-none border border-transparent focus:border-ice-blue">
                <!-- 移除了照片上傳區塊，改為純文字輸入 -->
                <div v-if="currentListType === 'shopping'" class="text-xs text-slate-400 text-center">
                    <i class="fa-solid fa-icons mr-1"></i>系統將自動對應圖示
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showListModal = false" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold text-sm">取消</button>
                <button @click="saveListItem" class="flex-[2] bg-accent-yellow text-deep-sea-blue py-3 rounded-xl font-bold text-sm shadow-lg">新增</button>
            </div>
        </div>
    </div>
    <!-- 3. Expense Modal -->
    <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-deep-sea-blue/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-center text-slate-800">記帳</h3>
            <div class="space-y-4">
                <!-- 幣別切換 -->
                <div class="flex space-x-2 bg-slate-50 p-1 rounded-xl">
                    <button @click="formExpense.currency='JPY'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-all" 
                            :class="formExpense.currency==='JPY' ? 'bg-white shadow text-deep-sea-blue' : 'text-slate-400'">
                        日幣 (¥)
                    </button>
                    <button @click="formExpense.currency='TWD'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-all" 
                            :class="formExpense.currency==='TWD' ? 'bg-white shadow text-deep-sea-blue' : 'text-slate-400'">
                        台幣 (NT$)
                    </button>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button v-for="cat in expenseCategories" @click="formExpense.category = cat.val" 
                        class="px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors" 
                        :class="formExpense.category === cat.val ? 'bg-deep-sea-blue text-white border-transparent' : 'bg-white text-slate-400 border-slate-200'">{{ cat.label }}</button>
                </div>
                <input v-model="formExpense.name" placeholder="項目" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                <div class="relative">
                    <span class="absolute left-3 top-3 text-slate-400 font-bold font-mono">{{ formExpense.currency === 'TWD' ? 'NT$' : '¥' }}</span>
                    <input v-model="formExpense.amount" type="number" class="w-full bg-slate-50 rounded-xl p-3 pl-12 text-lg font-bold font-mono outline-none">
                </div>
                <div class="flex space-x-2">
                    <button @click="formExpense.payment='現金'" :class="formExpense.payment==='現金'?'bg-accent-yellow text-deep-sea-blue':'bg-slate-50 text-slate-400'" class="flex-1 py-2 rounded-xl text-xs font-bold transition-colors">現金</button>
                    <button @click="formExpense.payment='信用卡'" :class="formExpense.payment==='信用卡'?'bg-blue-400 text-white':'bg-slate-50 text-slate-400'" class="flex-1 py-2 rounded-xl text-xs font-bold transition-colors">信用卡</button>
                </div>
                <select v-model="formExpense.date" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none"><option v-for="day in tripDays" :value="day.fullDate">{{ day.date }} {{ day.week }}</option></select>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showExpenseModal = false" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold text-sm">取消</button>
                <button @click="saveExpense" class="flex-[2] bg-deep-sea-blue text-white py-3 rounded-xl font-bold text-sm shadow-lg">儲存</button>
            </div>
        </div>
    </div>
</div>
<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;
    createApp({
        setup() {
            // --- Init ---
            const currentTab = ref('itinerary');
            const tabs = [
                { id: 'itinerary', icon: 'fa-solid fa-calendar-day' },
                { id: 'info', icon: 'fa-solid fa-circle-info' },
                { id: 'lists', icon: 'fa-solid fa-basket-shopping' },
                { id: 'expenses', icon: 'fa-solid fa-yen-sign' },
            ];
            
            // --- 圖片處理邏輯 ---
            const localFile = 'lia.jpg';
            const onlineFallback = 'https://images.unsplash.com/photo-1548265005-728b704c3298?q=80&w=2070&auto=format&fit=crop';
            
            const STORAGE_KEY = 'zao_cover_2026_fixed_v3';
            const storedCover = localStorage.getItem(STORAGE_KEY);
            
            const isUserUploaded = storedCover && storedCover.startsWith('data:image');
            const coverImage = ref(isUserUploaded ? storedCover : localFile);
            
            const handleImageError = (e) => {
                if (e.target.src === onlineFallback) return;
                console.warn('Local image not found, using fallback.');
                e.target.src = onlineFallback;
            };
            
            const resetCover = () => {
                localStorage.removeItem(STORAGE_KEY);
                coverImage.value = localFile; 
                setTimeout(() => {
                    const img = document.querySelector('.header-image-container img');
                    if(img) img.src = localFile;
                }, 50);
                alert('已重置為預設圖片 (lia.jpg)。');
            };
            const fileInput = ref(null);
            const triggerFileInput = () => fileInput.value.click();
            const handleImageUpload = (e) => { 
                const f = e.target.files[0]; 
                if (f) { 
                    const r = new FileReader(); 
                    r.onload = (ev) => { 
                        coverImage.value = ev.target.result; 
                        localStorage.setItem(STORAGE_KEY, ev.target.result); 
                    }; 
                    r.readAsDataURL(f); 
                }
            };
            
            // --- Data ---
            const tripDays = [
                { dayNum: '14', week: 'WED', fullDate: '2026-01-14' }, { dayNum: '15', week: 'THU', fullDate: '2026-01-15' }, { dayNum: '16', week: 'FRI', fullDate: '2026-01-16' },
                { dayNum: '17', week: 'SAT', fullDate: '2026-01-17' }, { dayNum: '18', week: 'SUN', fullDate: '2026-01-18' }, { dayNum: '19', week: 'MON', fullDate: '2026-01-19' },
            ];
            const selectedDayIndex = ref(0);
            
            const weatherInfo = computed(() => {
                const map = [
                    { temp: '-1°', feel: '-5°', icon: 'fa-solid fa-snowflake text-ice-blue', desc: '小雪 · 池袋' },
                    { temp: '-3°', feel: '-8°', icon: 'fa-solid fa-snowflake text-ice-blue', desc: '大雪 · 山形' },
                    { temp: '-8°', feel: '-15°', icon: 'fa-solid fa-icicles text-blue-300', desc: '暴風雪 · 藏王' },
                    { temp: '2°', feel: '-1°', icon: 'fa-solid fa-cloud text-slate-300', desc: '多雲 · 那須' },
                    { temp: '8°', feel: '5°', icon: 'fa-solid fa-sun text-accent-yellow', desc: '晴天 · 淺草' },
                    { temp: '9°', feel: '7°', icon: 'fa-solid fa-cloud-sun text-accent-yellow', desc: '多雲 · 上野' }
                ];
                return map[selectedDayIndex.value] || map[0];
            });
            // 行程資料
            const defaultItinerary = {
                0: [ 
                    { id: 101, category: 'flight', name: 'JX804 TPE→NRT', startTime: '15:00', endTime: '19:00', note: '第一航廈出發。抵達後記得：\n1. 領取 SIM 卡/WiFi\n2. 購買/儲值 Suica', transportType: 'public', transportTime: 120, openTime: '' },
                    { id: 102, category: 'transport', name: '成田機場第二航廈', startTime: '20:00', endTime: '21:35', note: 'A : 利木津巴士 → 東京車站 → 八丁堀站\nB : SKYLINER → 東京車站 → 八丁堀站\n購票處：成田二航 1F 入境大廳。\n預計約 21:35 抵達飯店', transportType: 'walk', transportTime: 5, openTime: '07:00-23:00' },
                    { id: 103, category: 'hotel', name: 'ICI HOTEL Tokyo Hatchobori', startTime: '21:35', endTime: '22:00', note: '先放行李再出門去超市買', transportType: 'walk', transportTime: 10, openTime: '24H' },
                    { id: 104, category: 'food', name: 'Maruetsu Petit Hatchōbori 4-Chōme Shop', startTime: '22:00', endTime: '23:00', note: '★ 記得去超市/超商買明天的早餐！', transportType: 'walk', transportTime: 0, openTime: '08:00–23:00' }
                ],
                1: [ 
                    { id: 200, category: 'walk', name: '池袋車站', startTime: '06:00', endTime: '06:15', note: '飯店 → 池袋車站\n步行前往車站', transportType: 'public', transportTime: 7 },
                    { id: 201, category: 'transport', name: '東京車站', startTime: '06:15', endTime: '06:46', note: '搭乘JR 山手線前往東京\n06:22 發車 (使用 JR PASS)\n確保 06:46 前抵達東京站轉乘', transportType: 'public', transportTime: 26 },
                    { id: 202, category: 'transport', name: '山形車站', startTime: '07:00', endTime: '09:53', note: '新幹線 Tsubasa 123號\n07:12 東京發車 → 09:53 山形著\n(使用 JR PASS / 指定席)\n可買車站便當', transportType: 'walk', transportTime: 30 },
                    { id: 203, category: 'hotel', name: 'Super Hotel 放行李', startTime: '10:30', endTime: '11:00', note: '山形站西口天然溫泉', transportType: 'walk', transportTime: 10, openTime: '15:00 CI' },
                    { id: 204, category: 'food', name: '午餐：庄司屋 蕎麥麵', startTime: '11:30', endTime: '12:30', note: '山形名物', transportType: 'walk', transportTime: 30, openTime: '11:00-15:00' },
                    { id: 205, category: 'transport', name: '大石田車站', startTime: '13:20', endTime: '14:21', note: 'JR 山形 → 大石田\n13:32 發車\n必須搭到!!', transportType: 'public', transportTime: 40 },
                    { id: 206, category: 'sightseeing', name: '銀山溫泉', startTime: '15:30', endTime: '16:10', note: '接駁巴士', transportType: 'walk', transportTime: 0 },
                    { id: 207, category: 'food', name: '銀山溫泉散策', startTime: '16:10', endTime: '17:40', note: '必吃：野川豆腐屋 (豆腐/炸豆腐)、Haikara-san 通瑞 (咖哩麵包)。\n拍照點：紅橋、能登屋旅館', transportType: 'public', transportTime: 40, openTime: '店家約17:00關' },
                    { id: 208, category: 'transport', name: '大石田車站', startTime: '17:20', endTime: '18:30', note: '搭乘接駁巴士回程\n末班車人多，請務必 17:20 (30分鐘前) 開始排隊！\n17:50 發車', transportType: 'public', transportTime: 50 },
                    { id: 209, category: 'food', name: '晚餐：米澤牛 登起波', startTime: '20:00', endTime: '21:30', note: '已訂位 (山形店)', transportType: 'walk', transportTime: 15, openTime: '17:00-22:00' },
                    { id: 210, category: 'hotel', name: '回 Super Hotel', startTime: '22:00', endTime: '22:00', note: '休息', transportType: 'walk', transportTime: 0 }
                ],
                2: [ 
                    { id: 301, category: 'hotel', name: '山形車站', startTime: '06:00', endTime: '06:15', note: '飯店出發 → 山形車站\n早起出門。注意保暖：暖暖包/發熱衣/冰爪', transportType: 'public', transportTime: 18 },
                    { id: 302, category: 'transport', name: '仙台車站', startTime: '06:33', endTime: '08:00', note: '搭乘JR 從山形車站 → 仙台車站\n必須搭到!!', transportType: 'walk', transportTime: 30 },
                    { id: 303, category: 'sightseeing', name: '仙台車站東口觀光巴士乘車處', startTime: '08:30', endTime: '08:45', note: 'KKDay 觀光巴士集合點', transportType: 'public', transportTime: 0 },
                    { id: 304, category: 'sightseeing', name: '寶珠山 立石寺', startTime: '09:00', endTime: '11:30', note: '跟團行程', transportType: 'public', transportTime: 60, ticketCost:'1000', openTime: '09:00-16:00' },
                    { id: 305, category: 'sightseeing', name: '藏王樹冰', startTime: '13:00', endTime: '16:30', note: '跟團行程 (纜車+樹冰)\n山頂極冷，注意相機電池耗電', transportType: 'public', transportTime: 120, ticketCost:'3500', openTime: '08:30-17:00' },
                    { id: 306, category: 'transport', name: '巴士返回仙台', startTime: '16:30', endTime: '18:30', note: '行程結束', transportType: 'walk', transportTime: 30 },
                    { id: 307, category: 'food', name: '烤牛舌 善治郎 仙台站前本店', startTime: '19:00', endTime: '20:30', note: '仙台站前本店 (未訂位)', transportType: 'walk', transportTime: 40, openTime: '11:00-22:30' },
                    { id: 308, category: 'transport', name: '山形車站', startTime: '21:18', endTime: '22:43', note: '搭車JR 從仙台車站 → 山形車站\n必須搭到!! (備案 22:15)', transportType: 'walk', transportTime: 0 }
                ],
                3: [ 
                    { id: 400, category: 'walk', name: '山形車站', startTime: '05:30', endTime: '05:45', note: '飯店出發 → 山形車站\n辦理退房，前往車站', transportType: 'public', transportTime: 14 },
                    { id: 401, category: 'transport', name: '郡山（福島）駛', startTime: '05:59', endTime: '07:23', note: '搭乘山形新幹線 →郡山轉乘東北新幹線\nTSUBASA 172 必須搭到!!', transportType: 'public', transportTime: 9 },
                    { id: 402, category: 'transport', name: '那須鹽原車站', startTime: '07:32', endTime: '07:54', note: '搭乘東北新幹線→那須鹽原\nYAMABIKO 206 必須搭到!!', transportType: 'walk', transportTime: 30 },
                    { id: 403, category: 'transport', name: '接駁巴士 → 那須動物王國', startTime: '09:15', endTime: '10:25', note: '僅此一班 必須搭到!! (8:30先排隊)', transportType: 'walk', transportTime: 0 },
                    { id: 404, category: 'sightseeing', name: '那須動物王國', startTime: '10:25', endTime: '15:15', note: '午餐：山貓餐廳', transportType: 'public', transportTime: 45, ticketCost:'2400', openTime: '10:00-16:00' },
                    { id: 405, category: 'transport', name: '巴士 回程 → 車站', startTime: '16:00', endTime: '17:00', note: '僅此一班 必須搭到!! (15:15先排隊)', transportType: 'walk', transportTime: 0 },
                    { id: 406, category: 'food', name: '空檔休息', startTime: '17:00', endTime: '18:00', note: '車站候車室 或 BECK\'S COFFEE', transportType: 'public', transportTime: 3 },
                    { id: 407, category: 'transport', name: '上野車站', startTime: '18:03', endTime: '19:10', note: '搭乘JR 那須鹽原車站 → 上野車站 → 鶯谷車站 → 走路到飯店\n必須搭到!!', transportType: 'walk', transportTime: 15 },
                    { id: 408, category: 'hotel', name: 'LANDABOUT Check-in', startTime: '19:25', endTime: '20:00', note: '鶯谷站', transportType: 'walk', transportTime: 15, openTime: '24H' },
                    { id: 409, category: 'food', name: 'Depot', startTime: '20:15', endTime: '21:30', note: '逛完街可以吃 AFURI\n有樂町附近', transportType: 'walk', transportTime: 30, openTime: '11:00-22:00' }
                ],
                4: [ 
                    { id: 500, category: 'walk', name: '飯店出發', startTime: '09:15', endTime: '09:30', note: '前往早餐店', transportType: 'walk', transportTime: 15 },
                    { id: 501, category: 'food', name: 'EGG BABY CAFE', startTime: '09:30', endTime: '10:30', note: '排隊名店', transportType: 'walk', transportTime: 20, openTime: '10:00-22:00' },
                    { id: 502, category: 'sightseeing', name: '淺草散策', startTime: '11:00', endTime: '13:00', note: '雷門、仲見世通、西參道', transportType: 'walk', transportTime: 10, openTime: '24H' },
                    { id: 503, category: 'food', name: '淺草今半 國際通本店', startTime: '13:00', endTime: '14:30', note: '國際通本店排隊', transportType: 'walk', transportTime: 30, openTime: '11:30-21:30' },
                    { id: 504, category: 'sightseeing', name: '銀座', startTime: '15:00', endTime: '18:00', note: '上野動物園視情況\n視時間決定', transportType: 'walk', transportTime: 20, ticketCost:'600', openTime: '09:30-17:00' },
                    { id: 505, category: 'shopping', name: '東京車站一番街', startTime: '18:30', endTime: '20:00', note: '伴手禮採買', transportType: 'walk', transportTime: 20, openTime: '10:00-20:00' }
                ],
                5: [ 
                    { id: 600, category: 'walk', name: '飯店出發', startTime: '06:15', endTime: '06:30', note: '退房，前往麥當勞', transportType: 'walk', transportTime: 0 },
                    { id: 601, category: 'food', name: 'McDonald\'s マクドナルド 鴬谷北口店', startTime: '06:30', endTime: '07:00', note: '可先去吃早餐再拿行李退房，或是買回飯店吃', transportType: 'public', transportTime: 30, openTime: '06:00-24:00' },
                    { id: 602, category: 'transport', name: '東京車站', startTime: '07:30', endTime: '08:00', note: '搭乘JR 山手線鶯谷8:29前往東京車站', transportType: 'walk', transportTime: 30 },
                    { id: 603, category: 'transport', name: '成田機場第二航廈', startTime: '09:14', endTime: '10:30', note: '搭乘N’EX 13 9:30發車前往成田第二航廈，10:28抵達', transportType: 'walk', transportTime: 0 },
                    { id: 604, category: 'flight', name: 'JX801 NRT→TPE', startTime: '13:45', endTime: '16:50', note: 'JX801 第二航廈出發', transportType: 'none', transportTime: 0 }
                ]
            };
            // 升級 key 到 v7
            const itineraryData = ref(JSON.parse(localStorage.getItem('zao_itinerary_2026_snow_v7')) || defaultItinerary);
            watch(itineraryData, () => localStorage.setItem('zao_itinerary_2026_snow_v7', JSON.stringify(itineraryData.value)), { deep: true });
            
            const currentDayItinerary = computed(() => itineraryData.value[selectedDayIndex.value] || []);
            // Helper Functions
            const isImportant = (n) => n && (n.includes('必須') || n.includes('必搭'));
            const getCategoryName = (c) => ({sightseeing:'景點',food:'美食',shopping:'購物',hotel:'住宿',flight:'航班',transport:'交通',walk:'步行'}[c]||'其他');
            
            // New Theme Function
            const getCategoryTheme = (c) => {
                const themes = {
                    sightseeing: { icon: 'fa-solid fa-camera', text: 'text-emerald-500', bgLight: 'bg-emerald-100', dot: 'bg-emerald-500' },
                    food: { icon: 'fa-solid fa-utensils', text: 'text-orange-500', bgLight: 'bg-orange-100', dot: 'bg-orange-500' },
                    shopping: { icon: 'fa-solid fa-bag-shopping', text: 'text-pink-500', bgLight: 'bg-pink-100', dot: 'bg-pink-500' },
                    hotel: { icon: 'fa-solid fa-bed', text: 'text-indigo-500', bgLight: 'bg-indigo-100', dot: 'bg-indigo-500' },
                    flight: { icon: 'fa-solid fa-plane', text: 'text-blue-500', bgLight: 'bg-blue-100', dot: 'bg-blue-500' },
                    transport: { icon: 'fa-solid fa-train-subway', text: 'text-sky-500', bgLight: 'bg-sky-100', dot: 'bg-sky-500' },
                    walk: { icon: 'fa-solid fa-person-walking', text: 'text-teal-500', bgLight: 'bg-teal-100', dot: 'bg-teal-500' }
                };
                return themes[c] || { icon: 'fa-solid fa-star', text: 'text-slate-400', bgLight: 'bg-slate-100', dot: 'bg-slate-300' };
            };
            const getCategoryColor = (c) => getCategoryTheme(c).dot;
            const getTransportIcon = (t) => ({walk:'fa-solid fa-person-walking',car:'fa-solid fa-car',public:'fa-solid fa-train-subway'}[t]||'fa-solid fa-arrow-right');
            const openMap = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
            
            // Icon Helper
            const getShoppingIcon = (name) => {
                if(!name) return 'fa-solid fa-bag-shopping';
                if(name.includes('衣') || name.includes('褲') || name.includes('服') || name.includes('UNIQLO') || name.includes('GU')) return 'fa-solid fa-shirt';
                if(name.includes('鞋') || name.includes('靴')) return 'fa-solid fa-shoe-prints';
                if(name.includes('藥') || name.includes('維他命') || name.includes('EVE') || name.includes('痛')) return 'fa-solid fa-capsules';
                if(name.includes('包')) return 'fa-solid fa-suitcase';
                if(name.includes('粧') || name.includes('水') || name.includes('乳') || name.includes('眉')) return 'fa-solid fa-wand-magic-sparkles';
                if(name.includes('吃') || name.includes('麵') || name.includes('餅') || name.includes('食')) return 'fa-solid fa-cookie-bite';
                if(name.includes('酒')) return 'fa-solid fa-wine-glass';
                if(name.includes('電') || name.includes('充')) return 'fa-solid fa-plug';
                return 'fa-solid fa-gift';
            };
            // --- Modals Logic ---
            const showItineraryModal = ref(false);
            const isEditing = ref(false);
            const editingIndex = ref(-1);
            const formItinerary = ref({});
            
            const openAddModal = () => { isEditing.value = false; formItinerary.value = {category:'sightseeing', transportType:'car', transportTime:15, openTime:''}; showItineraryModal.value = true; };
            const openEditModal = (item, idx) => { isEditing.value = true; editingIndex.value = idx; formItinerary.value = {...item}; showItineraryModal.value = true; };
            
            const saveItinerary = () => {
                if(!itineraryData.value[selectedDayIndex.value]) itineraryData.value[selectedDayIndex.value] = [];
                if(isEditing.value) itineraryData.value[selectedDayIndex.value][editingIndex.value] = {...formItinerary.value, id: Date.now()};
                else itineraryData.value[selectedDayIndex.value].push({...formItinerary.value, id: Date.now()});
                showItineraryModal.value = false;
            };
            
            const confirmDeleteItinerary = () => {
                if(confirm('確定要刪除這個行程嗎？此動作無法復原。')) {
                    itineraryData.value[selectedDayIndex.value].splice(editingIndex.value, 1);
                    showItineraryModal.value = false;
                }
            };
            // --- Other Tabs Logic ---
            const exchangeInput = ref('');
            const exchangeResult = computed(() => (parseFloat(exchangeInput.value || 0) * 0.22).toFixed(1));
            
            const hotels = [
                {name:'太陽城王子', note:'Day 1 · 池袋'}, {name:'山形 Super Hotel', note:'Day 2-3 · 天然溫泉'}, {name:'LANDABOUT TOKYO', note:'Day 4-5 · 鶯谷'}
            ];
            const currentListType = ref('todo');
            const listTypes = [{id:'todo',name:'待辦'},{id:'packing',name:'行李'},{id:'shopping',name:'購物'}];
            const currentListTypeName = computed(()=>listTypes.find(t=>t.id===currentListType.value)?.name);
            const lists = ref({todo:[],packing:[],shopping:[]});
            
            // Init Lists (v7)
            onMounted(() => {
                const saved = JSON.parse(localStorage.getItem('zao_lists_2026_snow_v7'));
                if(saved) lists.value = saved;
                else {
                    lists.value.todo = [
                        {name:'投保旅遊險 (6天)',checked:false}, 
                        {name:'日本網路 eSIM (6天)',checked:false}, 
                        {name:'KKDAY購買 利木津巴士 (機場→池袋)',checked:false}, 
                        {name:'VJW填寫 (入境審查)',checked:false},
                        {name:'確認護照效期 (至少6個月)',checked:false},
                        {name:'換日幣/準備信用卡',checked:false}
                    ];
                    lists.value.packing = [
                        {name:'免洗內褲 (男/女)',checked:false}, 
                        {name:'刮鬍刀',checked:false}, 
                        {name:'化妝包 (粉底、保濕、噴霧)',checked:false}, 
                        {name:'護照',checked:false}, 
                        {name:'發熱衣/褲',checked:false},
                        {name:'行動電源 & 充電線',checked:false},
                        {name:'雪靴/防滑鞋 (藏王必備)',checked:false},
                        {name:'墨鏡 (雪地防反光)',checked:false},
                        {name:'暖暖包 (大量)',checked:false},
                        {name:'個人常備藥品',checked:false}
                    ];
                    lists.value.shopping = [
                        {name:'發熱衣褲 (男/女)',checked:false}, 
                        {name:'洗髮精',checked:false}, 
                        {name:'DHC維他命',checked:false}, 
                        {name:'UNIQLO / GU 買衣服',checked:false}, 
                        {name:'眉粉',checked:false},
                        {name:'休足時間/貼布',checked:false},
                        {name:'EVE止痛藥/感冒藥',checked:false}
                    ];
                }
            });
            // Update storage key to v7
            watch(lists, ()=>localStorage.setItem('zao_lists_2026_snow_v7', JSON.stringify(lists.value)), {deep:true});
            // List Modal
            const showListModal = ref(false);
            const formList = ref({name:'', image:null});
            const openListModal = () => { formList.value = {name:'', image:null}; showListModal.value = true; };
            const handleListImage = (e) => { const f=e.target.files[0]; if(f){const r=new FileReader(); r.onload=(ev)=>formList.value.image=ev.target.result; r.readAsDataURL(f);} };
            const saveListItem = () => { lists.value[currentListType.value].push({...formList.value, checked:false}); showListModal.value=false; };
            const deleteListItem = (type, idx) => { if(confirm('刪除?')) lists.value[type].splice(idx, 1); };
            
            // New Packing
            const newPackingItem = ref('');
            const quickAddPacking = () => { if(newPackingItem.value) { lists.value.packing.push({name:newPackingItem.value, checked:false}); newPackingItem.value=''; }};
            // Recommendation
            const recommendations = [
                {name:'樹冰羅曼', city:'山形', icon:'   🏔   ️'}, {name:'乃し梅', city:'山形', icon:'   🍑   '}, 
                {name:'萩之月', city:'仙台', icon:'   🌕   '}, {name:'喜久福', city:'仙台', icon:'   🍵   '},
                {name:'NY Cheese', city:'東京', icon:'   🧀   '}, {name:'Press Butter', city:'東京', icon:'   🍪   '}
            ];
            const addRecItem = (rec) => {
                if(confirm(`加入 ${rec.name} ?`)) lists.value.shopping.push({name:rec.name, image:null, checked:false});
            };
            
            // --- Expenses Logic Updated for Multi-Currency ---
            const showExpenseModal = ref(false);
            // 升級 Storage Key，避免資料衝突
            const expenses = ref(JSON.parse(localStorage.getItem('zao_expenses_2026_snow_v2')) || []);
            const formExpense = ref({});
            const expenseCategories = [{val:'transport',label:'交通'},{val:'food',label:'飲食'},{val:'hotel',label:'住宿'},{val:'shopping',label:'購物'},{val:'other',label:'其他'}];
            
            // 匯率常數
            const RATE_JPY_TO_TWD = 0.22;
            
            // 1. 計算總台幣 (所有項目都換算成台幣加總)
            const totalExpensesTWD = computed(() => {
                return expenses.value.reduce((total, item) => {
                    let amount = parseInt(item.amount || 0);
                    // 如果是日幣，乘以匯率變成台幣 (並四捨五入)
                    if (item.currency === 'JPY') {
                        return total + Math.round(amount * RATE_JPY_TO_TWD);
                    }
                    // 如果是台幣，直接加
                    return total + amount;
                }, 0);
            });
            // 2. 計算總日幣 (所有項目都換算成日幣加總，顯示用)
            const totalExpensesJPY = computed(() => {
                return expenses.value.reduce((total, item) => {
                    let amount = parseInt(item.amount || 0);
                    // 如果是台幣，除以匯率變成日幣 (並四捨五入)
                    if (item.currency === 'TWD') {
                        return total + Math.round(amount / RATE_JPY_TO_TWD);
                    }
                    // 如果是日幣，直接加
                    return total + amount;
                }, 0);
            });
            // 3. 分類統計：現金 vs 信用卡 (都以台幣計算)
            const expenseStats = computed(() => {
                let cash = 0;
                let card = 0;
                
                expenses.value.forEach(item => {
                    let amount = parseInt(item.amount || 0);
                    let valInTWD = 0;
                    // 統一換算成台幣
                    if (item.currency === 'JPY') {
                        valInTWD = Math.round(amount * RATE_JPY_TO_TWD);
                    } else {
                        valInTWD = amount;
                    }
                    if (item.payment === '信用卡') {
                        card += valInTWD;
                    } else {
                        cash += valInTWD;
                    }
                });
                return { cash, card };
            });
            const sortedExpenses = computed(()=>[...expenses.value].reverse());
            
            const openExpenseModal = () => { 
                // 預設 currency 為 JPY
                formExpense.value = {
                    currency: 'JPY',
                    category: 'food',
                    name: '',
                    amount: '',
                    payment: '現金',
                    date: tripDays[selectedDayIndex.value].fullDate
                }; 
                showExpenseModal.value = true; 
            };
            
            const saveExpense = () => { 
                expenses.value.push({...formExpense.value}); 
                localStorage.setItem('zao_expenses_2026_snow_v2', JSON.stringify(expenses.value)); 
                showExpenseModal.value = false; 
            };
            
            const deleteExpense = (idx) => { 
                if(confirm('刪除?')) { 
                    expenses.value.splice(expenses.value.length - 1 - idx, 1); 
                    localStorage.setItem('zao_expenses_2026_snow_v2', JSON.stringify(expenses.value)); 
                }
            };
            
            const getExpenseColor = (c) => ({transport:'bg-orange-400',food:'bg-red-400',hotel:'bg-indigo-400',shopping:'bg-purple-400'}[c]||'bg-slate-400');
            const getExpenseIcon = (c) => ({transport:'fa-solid fa-train',food:'fa-solid fa-utensils',hotel:'fa-solid fa-bed',shopping:'fa-solid fa-bag-shopping'}[c]||'fa-solid fa-coins');
            
            return {
                currentTab, tabs, coverImage, triggerFileInput, handleImageUpload, fileInput,
                tripDays, selectedDayIndex, weatherInfo,
                currentDayItinerary, isImportant, getCategoryName, getCategoryColor, getCategoryTheme, getTransportIcon, openMap,
                showItineraryModal, isEditing, formItinerary, openAddModal, openEditModal, saveItinerary, confirmDeleteItinerary,
                exchangeInput, exchangeResult, hotels,
                currentListType, listTypes, currentListTypeName, lists, showListModal, formList, openListModal, handleListImage, saveListItem, deleteListItem, 
                newPackingItem, quickAddPacking, recommendations, addRecItem,
                expenses, sortedExpenses, totalExpensesJPY, totalExpensesTWD, expenseStats, showExpenseModal, formExpense, expenseCategories, openExpenseModal, saveExpense, deleteExpense, getExpenseColor, getExpenseIcon,
                getShoppingIcon, handleImageError, resetCover
            };
        }
    }).mount('#app');
</script>
</body>
</html>